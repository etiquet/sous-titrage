#include "BB.Globals_C.h"#include <Folders.h>			// les globals 	extern MyQDGlobals QD;	extern AppGlobals G;	//#pragma segment GestionsDesPreferences	pascal void LitPreferenceGenerale(void);pascal void PutPrefAffInGeneralPref(void);pascal void PutFonctionKeyinPref(void);pascal void PutVerifListeinPref(PrefVerifListeHandle	PrefVerif);pascal void GetVerifListeinPref(PrefVerifListeHandle*	PrefVerif);pascal void EcritPreferenceTravail(void);pascal void GetAvPref(AvPrefHandle*	PrefVerif);OSErr  GetBBpref(short *idFichier);OSErr  GetBBprefAffich(short *idFichier);OSErr  GetBBprefDernierFilm(short *idFichier);OSErr  GetBBPrefDirID(long *dirid,short *rNum);extern long gStartSecond;extern DialogPtr gMonitor;extern short gModeSaisieTC;void GereStartupPref(void){Boolean exist,err;Str255	st0,st1,st2;/* on regarde si: le fichier existe et dans le cas contraire on le créer*/	//SysBreak();	exist=PreferencesFileExists ('Bbou', 'Préf');	if (!exist){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		err = NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		}			exist=PreferencesFileExists ('Bbou', 'Pré1');	if (!exist){		GetIndString(&st0,138,2);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		err = NewPreferencesFile ('Bbou','Pré1', &st0, &st1,&st2);		}			exist=PreferencesFileExists ('Bbou','Pré2');	if (!exist){		GetIndString(&st0,138,3);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		err = NewPreferencesFile ('Bbou','Pré2', &st0, &st1,&st2);		}} //GereStartupPrefpascal	OSErr WriteKerningInResource(KerningMasterListHandle list){	short	vRefNum;	short	idFichier=-1;	long	dirID;	OSErr	CodeErreur;	FInfo  fndrInfo;	Handle	handle,h;		//CurResFile/* on récupère le fichier préférence */	h=(Handle)list;	HandToHand(&h);	CodeErreur = FindFolder(kOnSystemDisk, kPreferencesFolderType, kCreateFolder, &vRefNum, &dirID); 	if(CodeErreur == noErr)	{		idFichier = HOpenResFile(vRefNum, dirID, "\pBon Bougre™ Default Kern", fsRdWrShPerm);		if((idFichier == -1) ) // le fichier n'existe pas, on le créé (si on nous le demande)		{			HCreateResFile(vRefNum, dirID,"\pBon Bougre™ Default Kern");			fndrInfo.fdType='Pré1';			fndrInfo.fdCreator='Bbou';			fndrInfo.fdFlags=0;			CodeErreur = HSetFInfo(vRefNum, dirID, "\pBon Bougre™ Default Kern",&fndrInfo);			idFichier = HOpenResFile(vRefNum, dirID, "\pBon Bougre™ Default Kern", fsRdWrShPerm);		}   }		if (idFichier !=-1) {		/* Nous demande t-on de créer un alias pour le fichier ?*/				// on créer un alias manager pour le fichier en cour				if (CodeErreur == noErr) {			/* on enlève le dernier fichier utilisé */			handle=GetResource('Kern',128);						if( handle != nil) {				RmveResource(handle);				DisposeHandle(handle);				}							AddResource((Handle)h,'Kern',128,"\p Kern par defaut");			  			WriteResource((Handle)h);			ReleaseResource((Handle)h);			}			  		CloseResFile(idFichier);	} // id fichier != -1	return	CodeErreur;}/* 	Cette routine créer les préférences pour la dernière polices d'affichage utilisée*/pascal	OSErr MakePrefFileLastDisplayFontUsed(target,thefontrender)		FSSpec 				*target;			FontRenderRecord	*thefontrender;{	short	id;	short	idFichier=-1;	OSErr	CodeErreur;	AliasHandle	alias;	Handle	handle;	Str255	st0,st1,st2;/* on récupère le fichier préférence */	CodeErreur=GetBBprefAffich(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,2);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur = NewPreferencesFile ('Bbou','Pré1', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Pré1', &idFichier); 		}			if (CodeErreur==noErr) {		/* 				on créer un alias manager pour la police en cours		*/				/* Nous demande t-on de créer un alias pour le fichier ?*/		if (target != nil) { 			  CodeErreur=NewAlias((FSSpecPtr) nil,target,&alias);			  if (CodeErreur == noErr) {				  DeletePreference (idFichier,'Alia', 128);				  id=128;				  WritePreference (idFichier,'Alia',&id,(Handle)alias);				  DisposeHandle((Handle)alias);				  }			  		} // target != nil					/* Nous demande t-on de reporter les info de la police (kerning + couleurs) ? */				if (thefontrender != nil) { // oui			DeletePreference (idFichier,'Rfon', 128);			handle=NewHandle(sizeof(FontRenderRecord));			HLock(handle);			BlockMove(thefontrender,(Ptr)*handle,sizeof(FontRenderRecord));			(**(FontRenderRecordHandle)handle).interligne=G.Display_interligne;			HUnlock(handle);		 	id=128;			WritePreference (idFichier,'Rfon',&id,handle);			DisposeHandle(handle);			/* on enlève le dernier fichier utilisé  en couleur d'affichage			*/			DeletePreference (idFichier,'Colo', 128);			handle=GetGlobalRgbColorHandle();			id=128;			WritePreference (idFichier,'Colo',&id, handle);			DisposeHandle(handle);		} // thefontrender != nil		ClosePreferencesFile(idFichier);	} // id fichier != -1	return	CodeErreur;}pascal	Boolean	OpenLastDisplayFontUsed(void){	short	itemHit;	short	idFichier=-1,resourceID;	OSErr	err;	Handle	alias,handle;	Boolean	wasChanged,opened=false;	FSSpec	target;	/* on récupère le fichier préférence */		err=GetBBprefAffich(&idFichier);		if(err==noErr ) 	{		/* on récupère l'alias */		resourceID=128;		alias=nil;		err=ReadPreference (idFichier, 'Alia', &resourceID,&alias);		if( alias != nil) {			err=ResolveAlias( (FSSpecPtr) nil,(AliasHandle)alias,&target,&wasChanged);			if (err == noErr) {				ParamText(&(target.name),nil,nil,nil);				gStartSecond=-2;				itemHit = Alert(242,(ModalFilterProcPtr) &Filter_WithCountDown); // on demande l'autorisation à l'utilisateur				if (itemHit==1) {					// on recopie les couleurs de la font					resourceID=128;					alias=nil;					err=ReadPreference (idFichier,'Colo', &resourceID,&handle);							if (handle !=nil) {						CopieLesCouleurs(handle);						ReleaseResource(handle);						}								resourceID=128;					handle=nil;					err=ReadPreference (idFichier,'Rfon', &resourceID,&handle);							C_DoFileOpen(&target);										if (handle) {						 G.Display_interligne=(**(FontRenderRecordHandle)handle).interligne;						 G.Display_Font.NormalKerning=(**(FontRenderRecordHandle)handle).NormalKerning;						 G.Display_Font.spaceWidth=(**(FontRenderRecordHandle)handle).spaceWidth;						ReleaseResource(handle);					}												opened=true;				} else {					// on a répondu non					// on enlève la resource					DeletePreference (idFichier,'Alia', 128);					}				} // err == no err						ReleaseResource(alias);					} // alias != nil 		ClosePreferencesFile(idFichier);		} // pas erreur ouverture fichier!= -1 	return	err;} //OpenLastDisplayFontUsed/*-----------------------------------------------------*/pascal	Boolean MakeCurentFileAliasInPref(alias)	AliasHandle alias;{	short	id;	short	idFichier=-1;	OSErr	CodeErreur;	Str255	st0,st1,st2;	DialogPtr	wait_dlog;				//return; //!! pour l'instant on ne la fait pas		// on rafraichie les fenêtre		DrawListingWindow();		UpdateSaisie();		// on commence par scanner le disque dur	à la recherche des polices		 wait_dlog= GetNewDialog(140,nil,(WindowPtr)-1);		 SetPort(wait_dlog);			 TextFont(geneva); 		 TextSize(9); 		 DrawDialog(wait_dlog);			CodeErreur=GetBBprefDernierFilm(&idFichier);		if (CodeErreur!=noErr) {					GetIndString(&st0,138,3);					GetIndString(&st1,138,6);					GetIndString(&st2,138,7);					CodeErreur=NewPreferencesFile ('Bbou','Pré2', &st0, &st1,&st2);					CodeErreur=OpenPreferencesFile ('Bbou', 'Pré2', &idFichier); 					}				if (CodeErreur ==noErr){					/* on enlève le dernier fichier utilisé */			DeletePreference (idFichier,'Alia', 1128);			if (alias != nil) {						id=1128;					WritePreference (idFichier,'Alia', &id,(Handle)alias);					}			ClosePreferencesFile(idFichier);		} //  CodeErreur==noerr		DisposeDialog(wait_dlog ); 	return true;}pascal	Boolean	OpenLastFileUsed(void){	short	itemHit,resourceID;	short	idFichier=-1,odocErr;	OSErr	err;	Handle	alias;	Boolean	wasChanged,opened=false;	FSSpec	target;	AEDescList		documentList;	long			itemsInList;/* on récupère le fichier préférence */		err=GetBBprefDernierFilm(&idFichier);						if(err == noErr){			 /* on récupère l'alias */			 resourceID=1128;			 alias=nil;			 err=ReadPreference (idFichier, 'Alia', &resourceID,&alias);				 			 if( alias != nil) {				 err=ResolveAlias( (FSSpecPtr) nil,(AliasHandle)alias,&target,&wasChanged);				 if (err == noErr) {					 ParamText(&(target.name),nil,nil,nil);					 gStartSecond=-2;					 itemHit = Alert(243,(ModalFilterProcPtr)&Filter_WithCountDown); // on demande l'autorisation à l'utilisateur					 					 if (itemHit==1) {						 C_DoFileOpen(&target);						 opened=true;						 }					 } // err == no err				 				 ReleaseResource(alias);				 			 } // handle != nil 			 			ClosePreferencesFile(idFichier);		 } // id fichier != -1 	return	err;} //OpenLastFileUsed/* ----------------*/pascal	void	DeleteLastFileUsed(void){	short	idFichier=-1;	OSErr	err;	Boolean	opened=false;		/* on récupère le fichier préférence */	err=GetBBprefDernierFilm(&idFichier);		if(err==noErr){			/* on enlève le dernier fichier utilisé */			DeletePreference (idFichier,'Alia', 1128);			ClosePreferencesFile(idFichier);		 } //err} //DeleteLastFileUsedpascal short OpenBBPreferenceFile(short create){	short	vRefNum,retour;	short	idFichier=-1;	long	dirID,var1;	OSErr	CodeErreur;	FInfo  fndrInfo;	KerningMasterListPtr		var2;	Handle	alias;	long*	lp;/* on récupère le fichier préférence */	retour=-1;	if (create==create) {}	CodeErreur = FindFolder(kOnSystemDisk, kPreferencesFolderType, kCreateFolder, &vRefNum, &dirID); 	if(CodeErreur == noErr)	{		short savedResFile = CurResFile();		idFichier = HOpenResFile(vRefNum, dirID, "\pPréference Bon Bougre ", fsRdWrShPerm);   					if(idFichier != -1){			alias=Get1Resource('Alia',129);			CodeErreur = HGetFInfo(vRefNum, dirID,"\pPréference Bon Bougre ",&fndrInfo);			var2=(KerningMasterListPtr)(*alias);				lp=(long*)*alias;			var1=*lp;			if (fndrInfo.fdFlags !=0 ) 				if (var1==0x1879)  retour=1;							ReleaseResource(alias);					CloseResFile(idFichier);			}				 UseResFile (savedResFile);	} // code erreur			return retour;		}pascal	OSErr SetSerialPreference(void){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	Handle	handle;	Str255	st0,st1,st2;/* on récupère le fichier préférence */	CodeErreur=GetBBpref(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}			if (CodeErreur==noErr) {				/* on enlève la vieille resource */				DeletePreference (idFichier,'FreP', 132);			handle=NewHandleClear(16);			HLock(handle);			*((short*)*handle)=G.LecteurTimeCode_Type;			*((short*)*handle+4)=G.Player_TC_src;			*((short*)*handle+4)=G.Mode_Commutateur;			HUnlock(handle);			id=132;			WritePreference (idFichier,'FreP', &id,handle);			DisposeHandle((Handle)handle);				/* on ferme le fichier */				ClosePreferencesFile(idFichier);	} //CodeErreur==noErr		return	CodeErreur;} // SetSerialPreferencepascal void EcritPreferenceTravail(void){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	PreferenceTravail_ResourceHandle	handle;	WindowPeek	w;	GrafPtr		oldport;	Str255	st0,st1,st2;			GetPort(&oldport);/* on récupère le fichier préférence */	CodeErreur=GetBBpref(&idFichier);	if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}			if (CodeErreur==noErr) {			/* on enlève la vieille resource */				DeletePreference (idFichier,'FreP', 128);						/* on créer la nouvelle resource préférence de travail */			handle=(PreferenceTravail_ResourceHandle)NewHandleClear(sizeof(PreferenceTravail_Resource));			HLock((Handle)handle);			(**handle).Pt_BackDropFlag=G.Preference_MultiFinder;			(**handle).Pt_PatNum=G.BackDrop_PatNum; 		//n° de la pattern «ppat» du fond de l'écran			(**handle).Pt_Enchaine=G.Preference_Enchaine	;			(**handle).Pt_TypeVerification=G.Preference_UtilCheck;			(**handle).Pt_SauvegardeAuto=G.Preference_AutoCheck;			(**handle).Pt_SauvegardeDuree=G.Preference_NombreSauv;			(**handle).Pt_RenumerotationAuto= G.Preference_Renumerotation;			(**handle).Pt_Preference_LisiValue=G.Preference_LisiValue;			(**handle).Pt_Default_ListingSize=G.HauteurST ;			(**handle).Pt_Default_ListingFont=G.General_FontNumber ;			(**handle).Pt_ModeDeTravail=G.SaisieModePreferenciel;			(**handle).Pt_Interval=G.Preference_Interval;			(**handle).Pt_EffectMode=G.EffectMode;			(**handle).Pt_FadeTime=G.FadeTime;			(**handle).Pt_GrayInListing=G.General_Preference_DessinGris;			(**handle).Pt_OpenBlockNote=G.AutoOpenBlockNote;			// ouverture automatique Block-note oui / non			(**handle).Pt_Listing_PatNum=G.Listing_PatNum	;				// ppat pour listing			(**handle).Pt_Saisie_PatNum=G.Saisie_PatNum;					// ppat pour saisie			(**handle).Pt_AutoOpenBlockNote=G.AutoOpenBlockNote;				// ouverture automatique block note			(**handle).Pt_AutoOpenCheckList=G.AutoOpenCheckList;				// vérification automatique de la liste à l'ouverture			(**handle).Pt_AutoOpenLastFont=G.AutoOpenLastFont;				// ouvrir si bbof la police utilisée pour le film			(**handle).Pt_Echelle_Bandeau=G.Echelle_Bandeau;			(**handle).Pt_affiche_CR_Flag=(short)G.affiche_CR_Flag;			(**handle).Pt_OuvreDernierFilm_Flag=G.AutoOpenLastFile;			(**handle).Pt_ModeSaisieTC=gModeSaisieTC;			(**handle).Pt_offsetlecturestop=G.OffsetLectureTCStop;			(**handle).Pt_offsetlectureplay=G.OffsetLectureTCPlay;	/* on stocke position taille et visibilité de quelques fenêtres (ou palette flottante ) */			/* palette télécommande */			w=(WindowPeek)G.TELECOMMANDEWindow;			SetPort((WindowPtr)w);			(**handle).Pt_PaletteTelecommandeRect=((WindowPtr)w)->portRect;			// position palette télécommande			LocalToGlobal((Point*)&(**handle).Pt_PaletteTelecommandeRect);			LocalToGlobal((Point*)&(**handle).Pt_PaletteTelecommandeRect+1);			(**handle).Pt_PaletteTelecommandeVis=w->visible&0xff;			// palette telecommande visible ou non		/* Block Note */			w=(WindowPeek)G.BlockNoteWindow;			SetPort((WindowPtr)w);			(**handle).Pt_BlockNoteRect=((WindowPtr)w)->portRect;							// même chose pour block note ....			LocalToGlobal((Point*)&(**handle).Pt_BlockNoteRect);			LocalToGlobal((Point*)&(**handle).Pt_BlockNoteRect+1);			(**handle).Pt_BlockNoteVis=w->visible&0xff;					/* palette Chenille */			w=(WindowPeek)G.ChenilleWindow;			SetPort((WindowPtr)w);			(**handle).Pt_PaletteChenilleRect=((WindowPtr)w)->portRect;			// position palette télécommande			LocalToGlobal((Point*)&(**handle).Pt_PaletteChenilleRect);			LocalToGlobal((Point*)&(**handle).Pt_PaletteChenilleRect+1);			(**handle).Pt_PaletteChenilleVis=w->visible&0xff;			// palette telecommande visible ou non		/* palette simu */			w=(WindowPeek)gMonitor;			if (w) {				SetPort((WindowPtr)w);				(**handle).Pt_PaletteSimuRect=((WindowPtr)w)->portRect;	// position palette simu				LocalToGlobal((Point*)&(**handle).Pt_PaletteSimuRect);				LocalToGlobal((Point*)&(**handle).Pt_PaletteSimuRect+1);				(**handle).Pt_PaletteSimuVis=w->visible&0xff;			 // palette simulation visible ou non			} else {				(**handle).Pt_PaletteSimuRect.left=0;				(**handle).Pt_PaletteSimuRect.top=0;				(**handle).Pt_PaletteSimuRect.right=0;				(**handle).Pt_PaletteSimuRect.bottom=0;				(**handle).Pt_PaletteSimuVis=0;			}					/* fenêtre listing */			w=(WindowPeek)&G.ListingWindow;			SetPort((WindowPtr)w);			(**handle).Pt_ListingWindowRect=((WindowPtr)w)->portRect;			// position fenêtre listing			LocalToGlobal((Point*)&(**handle).Pt_ListingWindowRect);			LocalToGlobal((Point*)&(**handle).Pt_ListingWindowRect+1);									HUnlock((Handle)handle);						id=128;			WritePreference (idFichier,'FreP', &id,(Handle)handle);			DisposeHandle((Handle)handle);				/* on ferme le fichier */				ClosePreferencesFile(idFichier);	} //CodeErreur==noErr				SetPort(oldport);} // EcritPreferenceTravail	pascal void LitPreferenceGenerale(void) {	short	id;	short	idFichier=-1,resourceID;	OSErr	CodeErreur=-1;	Handle			handle;	PREF_AFF_RECHandle	par;	/* on récupère le fichier préférence */		CodeErreur=GetBBpref(&idFichier);		if (CodeErreur==noErr) {			/* on lit la resource préférence de travail */			id=128;			G.Preference_PourTravail=nil;			ReadPreference (idFichier,'FreP', &id,&G.Preference_PourTravail);			if (G.Preference_PourTravail){				HLock(G.Preference_PourTravail);				G.Preference_MultiFinder=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_BackDropFlag;				G.BackDrop_PatNum=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_PatNum; 		//n° de la pattern «ppat» du fond de l'écran				G.Preference_Enchaine=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Enchaine	;				G.Preference_UtilCheck=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_TypeVerification;				G.Preference_AutoCheck=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_SauvegardeAuto;				G.Preference_NombreSauv=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_SauvegardeDuree;				G.Preference_Renumerotation=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_RenumerotationAuto;				G.Preference_LisiValue=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Preference_LisiValue;				G.HauteurST=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Default_ListingSize ;				G.General_FontNumber=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Default_ListingFont ;				G.SaisieModePreferenciel=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_ModeDeTravail;				G.Preference_Interval=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Interval;				G.EffectMode=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_EffectMode;				G.FadeTime=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_FadeTime;				G.General_Preference_DessinGris=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_GrayInListing;				G.AutoOpenBlockNote=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_OpenBlockNote;			// ouverture automatique Block-note				G.Listing_PatNum=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Listing_PatNum	;				// ppat pour listing				G.Saisie_PatNum=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Saisie_PatNum;					// ppat pour saisie				G.AutoOpenBlockNote=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_AutoOpenBlockNote;				// ouverture automatique block note				G.AutoOpenCheckList=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_AutoOpenCheckList;				// vérification automatique de la liste à l'ouverture				G.AutoOpenLastFont=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_AutoOpenLastFont;				// ouvrir si bbof la police utilisée pour le film				G.Echelle_Bandeau=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_Echelle_Bandeau;				G.affiche_CR_Flag=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_affiche_CR_Flag;				G.AutoOpenLastFile=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_OuvreDernierFilm_Flag;				gModeSaisieTC=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_ModeSaisieTC;				G.OffsetLectureTCStop=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_offsetlecturestop;				G.OffsetLectureTCPlay=(**(PreferenceTravail_ResourceHandle)G.Preference_PourTravail).Pt_offsetlectureplay;								HUnlock(G.Preference_PourTravail);			} else AlertUser(28);	/* ### note: on laisse le handle préférence car il est utilisée plus en avant dans le logiciel							il est disposé à la fin de C_init */		// on regarde s'il y a une resource preference affichage (dans le fichier préférence)			resourceID=130;			par=nil;			CodeErreur=ReadPreference (idFichier, 'FreP', &resourceID,(Handle*)&par);					if (par) {	// on remplace les parramètres à partir de la resource.				G.X_Offset=(**par).Pref_XOffset;				G.Y_Offset=(**par).Pref_Baseline;				G.Boxing_Size=(**par).Pref_MaskSize;				G.VE_Mode=(**par).Pref_VeMode;				DisposeHandle((Handle)par);				}		// on charge la resource startup préférence				// note le table fct key est un byte mais l'allocation est un short				resourceID=129;				handle=nil;				CodeErreur=ReadPreference (idFichier, 'FreP', &resourceID,&handle);				if (handle){	// on affecte les préférences				BlockMove(*handle,(Ptr)&G.TableFonctionKeys,32);				DisposeHandle(handle);			}		// le type de lecteur de time code				resourceID=132;				handle=nil;				CodeErreur=ReadPreference (idFichier, 'FreP', &resourceID,&handle);							if (handle) {				G.LecteurTimeCode_Type=*((short*)*handle);				G.Player_TC_src=*((short*)*handle+1); // + 1 short ==2				G.Mode_Commutateur=*((short*)*handle+2);   // +2 short ==4				DisposeHandle(handle);				}			/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // LitPreferenceGenerale	pascal void PutPrefAffInGeneralPref(void){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	PREF_AFF_RECHandle par;	Str255	st0,st1,st2;/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}	if (CodeErreur==noErr) {				/* on enlève la vieille resource */				DeletePreference (idFichier,'FreP', 130);						/* on créer une nouvelle */			par=(PREF_AFF_RECHandle)NewHandleClear(sizeof(PREF_AFF_REC));		// on remplace les parramètres à partir de la resource.			(**par).Pref_XOffset=G.X_Offset;			(**par).Pref_Baseline=G.Y_Offset;			(**par).Pref_MaskSize=G.Boxing_Size;			(**par).Pref_VeMode=G.VE_Mode;			id=130;			WritePreference (idFichier,'FreP', &id,(Handle)par);			DisposeHandle((Handle)par);				/* on ferme le fichier */				ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // PutPrefAffInGeneralPrefpascal void PutFonctionKeyinPref(void){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	Handle	handle;	Str255	st0,st1,st2;/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}			if (CodeErreur==noErr) {			/* on enlève la vieille resource */				DeletePreference (idFichier,'FreP', 129);						/* on créer une nouvelle resource*/			handle=NewHandleClear(32);			HLock(handle);			BlockMove(&G.TableFonctionKeys,*handle,32);			HUnlock(handle);			id=129;			WritePreference (idFichier,'FreP', &id,handle);			DisposeHandle(handle);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // PutFonctionKeyinPrefpascal void PutExportFileinPref(PrefExportFichierHandle	PrefExport){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;		Str255	st0,st1,st2;/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}			if (PrefExport)		 if (CodeErreur==noErr) {			/* on enlève la vieille resource */				DeletePreference (idFichier,'FreP', 133);			/* on créer une nouvelle resource*/			id=133;			WritePreference (idFichier,'FreP', &id,(Handle)PrefExport);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // PutExportFileinPrefpascal void GetExportFileinPref(PrefExportFichierHandle*	PrefExport){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	OSErr	err;	/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur==noErr) {			/* on lit la resource*/			id=133;			err=ReadPreference (idFichier,'FreP', &id,(Handle*) PrefExport);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // GetExportFileinPrefpascal void PutVerifListeinPref(PrefVerifListeHandle	PrefVerif){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	Str255	st0,st1,st2;/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}		if (PrefVerif)		 if (CodeErreur==noErr) {			/* on enlève la vieille resource */				DeletePreference (idFichier,'FreP', 134);			/* on créer une nouvelle resource*/			id=134;			WritePreference (idFichier,'FreP', &id,(Handle)PrefVerif);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // PutVerifListeinPrefpascal void GetVerifListeinPref(PrefVerifListeHandle*	PrefVerif){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	OSErr	err;	/* on récupère le fichier préférence */		CodeErreur= GetBBpref(&idFichier);		if (CodeErreur==noErr) {			/* on lit la resource*/			id=134;			err=ReadPreference (idFichier,'FreP', &id,(Handle*) PrefVerif);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // GetVerifListeinPrefpascal void PutAvPref(AvPrefHandle	PrefVerif){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	Str255	st0,st1,st2;/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}	if (PrefVerif)		 if (CodeErreur==noErr) {			/* on enlève la vieille resource */				DeletePreference (idFichier,'AVRG', 128);			/* on créer une nouvelle resource*/			id=128;			WritePreference (idFichier,'AVRG', &id,(Handle)PrefVerif);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // PutAvPrefpascal void GetAvPref(AvPrefHandle*	PrefVerif){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	OSErr	err;	/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur==noErr) {			/* on lit la resource*/			id=128;			err=ReadPreference (idFichier,'AVRG', &id,(Handle*) PrefVerif);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // GetAvPrefpascal void PutAvFlagsPref(AvFlagsPrefHandle	PrefVerif){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	Str255	st0,st1,st2;	/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur){		GetIndString(&st0,138,1);		GetIndString(&st1,138,6);		GetIndString(&st2,138,7);		CodeErreur=NewPreferencesFile ('Bbou','Préf', &st0, &st1,&st2);		CodeErreur=OpenPreferencesFile ('Bbou', 'Préf', &idFichier); 		}			if (PrefVerif)		 if (CodeErreur==noErr) {			/* on enlève la vieille resource */				DeletePreference (idFichier,'AvFl', 128);			/* on créer une nouvelle resource*/			id=128;			WritePreference (idFichier,'AvFl', &id,(Handle)PrefVerif);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // PutAvFlagsPrefpascal void GetAvFlagsPref(AvFlagsPrefHandle*	PrefVerif){	short	id;	short	idFichier=-1;	OSErr	CodeErreur=-1;	OSErr	err;	/* on récupère le fichier préférence */	CodeErreur= GetBBpref(&idFichier);		if (CodeErreur==noErr) {			/* on lit la resource*/			id=128;			err=ReadPreference (idFichier,'AvFl', &id,(Handle*) PrefVerif);				/* on ferme le fichier */			ClosePreferencesFile(idFichier);	} //CodeErreur==noErr} // GetAvFlagsPrefOSErr  GetBBpref(short *idFichier){OSErr	err;short	vRefNum;long 		dirID;Str255	st0;		GetIndString((unsigned char*)&st0,138,1);  //nom fichier préférence		err =GetBBPrefDirID(&dirID,&vRefNum); 		if(err == noErr) { 				short savedResFile = CurResFile(); 				*idFichier = HOpenResFile(vRefNum,dirID,&st0,fsRdWrShPerm);   					UseResFile (*idFichier);				err=ResError();				UseResFile (savedResFile);				}		return err;		}OSErr  GetBBprefAffich(short *idFichier){OSErr	err;short	vRefNum;long 		dirID;Str255	st0;		GetIndString((unsigned char*)&st0,138,2); //nom fichier préférence affichage		err =GetBBPrefDirID(&dirID,&vRefNum); 		if(err == noErr) { 				short savedResFile = CurResFile(); 				*idFichier = HOpenResFile(vRefNum,dirID,&st0,fsRdWrShPerm);   					UseResFile (*idFichier);				err=ResError();				UseResFile (savedResFile);				}		return err;		}			OSErr  	GetBBprefDernierFilm(short *idFichier){OSErr	err;short	vRefNum;long 		dirID;Str255	st0;		GetIndString((unsigned char*)&st0,138,3);  //nom fichier préférence dernier fichier pref		err =GetBBPrefDirID(&dirID,&vRefNum); 		if(err == noErr) { 				short savedResFile = CurResFile(); 				*idFichier = HOpenResFile(vRefNum,dirID,&st0,fsRdWrShPerm);   					UseResFile (*idFichier);				err=ResError();				UseResFile (savedResFile);				}		return err;		}OSErr  GetBBPrefDirID(long *dirid,short *rNum){CInfoPBRec myPB; Str255 dirName; Str255 fullPath; OSErr myErr; OSErr	CodeErreur;short	vRefNum;long 		dirID;				CodeErreur = FindFolder(kOnSystemDisk, kPreferencesFolderType, kCreateFolder, &vRefNum, &dirID);		fullPath[0]=0;		myPB.hFileInfo.ioNamePtr=(unsigned char*)&dirName; 		myPB.hFileInfo.ioVRefNum=vRefNum;  		myPB.dirInfo.ioDrParID=dirID; 		myPB.dirInfo.ioFDirIndex = -1; 				do{			myPB.dirInfo.ioDrDirID= myPB.dirInfo.ioDrParID;   			myErr= PBGetCatInfo(&myPB, false);    						if ( dirName[1] != ':' ) { 						 		dirName[dirName[0]+1]=':';     			 		dirName[0]++;   			  	}           			 			 			BlockMove(&fullPath[1],&dirName[dirName[0]+1],fullPath[0]); dirName[0]+=fullPath[0];			BlockMove(&dirName[0],&fullPath[0],256);			 		 		}while (myPB.dirInfo.ioDrDirID !=fsRtDirID) ;		GetIndString((unsigned char*)&dirName,138,6); 		BlockMove(&dirName[1],&fullPath[fullPath[0]+1],dirName[0]); fullPath[0]+=dirName[0];   		   		myPB.hFileInfo.ioNamePtr=(unsigned char*)&fullPath; 		myPB.hFileInfo.ioVRefNum=0;  		myPB.dirInfo.ioDrParID=0; 		myPB.dirInfo.ioFDirIndex=0; 		myPB.dirInfo.ioDrDirID=0;   		   		myErr= PBGetCatInfo(&myPB, false); 		*dirid=dirID=myPB.dirInfo.ioDrDirID;		*rNum=vRefNum;				return nil;}