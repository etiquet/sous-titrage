/******************************************Cet ensemble de routines permet la gestion et le dispatch des fonctions accérées du power subtitling sur un power PC.*******************************************/#include "BB.Globals_C.h"#include "E3DEMO.H"#include "appleEventHandlers.h"#include <QuickTimeComponents.h>#include <ImageCompression.h>#include "hdwr.vx.h"#include <Palettes.h>#include "PPCDispatch.h"#include <CodeFragments.h>#include <Gestalt.h>extern AppGlobals G;extern MyQDGlobals QD;//#define __Debug__	static Handle	DrawStAccRes,DrawAcharRes,MyCopyBitsH,RenderAFontRes;static short	gAcceleratedResourceLoaded;//**************************************************// Initialisation et dispose des code resources PPC// cette fonction charge si c'est possible la ou les fonctions accélerées PPC// depuis les resourcesvoid PPCDispatch_init(void){	OSErr 		err;	long			response;	short		myBit;	Boolean		gHasCFM;		gAcceleratedResourceLoaded=false; // par defaut	DrawStAccRes=DrawAcharRes=MyCopyBitsH=nil;	gHasCFM=0;	// sommes nous sur une machine 68K ou PPC ?	Gestalt('cput',&response);	if ((response&0xFFF) >= 0x101) { // ppc ?		err = Gestalt(gestaltCFMAttr, &response);		myBit = gestaltCFMPresent;		gHasCFM = BitTst (&response, 31-myBit);	}					if (gHasCFM){  // si machine PPC		DrawStAccRes = Get1Resource('MWCW', 128 );		if (DrawStAccRes) 	HLock(DrawStAccRes);		DrawAcharRes = Get1Resource('MWCW', 129 );		if (DrawAcharRes) HLock(DrawAcharRes);		MyCopyBitsH = Get1Resource('MWCW', 130 );		if (MyCopyBitsH) HLock(MyCopyBitsH);			RenderAFontRes = Get1Resource('MWCW', 131 );		if (RenderAFontRes) HLock(RenderAFontRes);							if (DrawStAccRes && DrawAcharRes && MyCopyBits && RenderAFontRes){			gAcceleratedResourceLoaded=true;			} 	}// si machine PPC} //PPCDispatch_init//----- destructeur des fonctions accélérées -----------------void PPCDispatch_Dispose(void){	//à priori on s'en fou car exittoshell fait le boulot pour nous	// mais on fait du boulot propre...		if(DrawAcharRes) {		HUnlock(DrawAcharRes);		ReleaseResource(DrawAcharRes);		}		if(DrawStAccRes) {		HUnlock(DrawStAccRes);		ReleaseResource(DrawStAccRes);		}	if(MyCopyBitsH) {		HUnlock(MyCopyBitsH);		ReleaseResource(MyCopyBitsH);		}		gAcceleratedResourceLoaded=false; // par defaut}	//PPCDispatch_Dispose// fonction membre pour indiquer si l'on peut utiliser des fonctions PPC....// cette fonction revoie true si les resources PPCCode on été chargée correctemmentshort  PPCDispatch_AcceleratedExist(void){	return gAcceleratedResourceLoaded;}	//PPCDispatch_AcceleratedExist?//*******************************************// cette fonction est le wrapper pour MyCopyBits//avec la fonction en resource PPCpascal void PPCDispatch_MyCopyBits (char* source ,char* destination,long rowbytes,Rect* rect){	MyCopyBitsUPP	MyCopyBitsProc;				if (MyCopyBitsH){ // dispacht si resource pas loader		MyCopyBitsProc = (MyCopyBitsUPP)*MyCopyBitsH;		CallMyCopyBitsProc (MyCopyBitsProc, source,destination,rowbytes,rect);	} else {		MyCopyBits (source ,destination,rowbytes,rect);			}} //PPCDispatch_MyCopyBits//*******************************************// cette fonction est le wrapper pour draw_a_char//avec la fonction en resource PPCpascal short PPCDispatch_Call_C_Draw_A_Char(FontRenderRecordPtr  Font_Render,short  TheChar,					short TheStyle, long  Face_Color,long Border_Color,long Shadow_Color,long bgd_Color,					long  drapeau,short  Xpos ,short Ypos ,char* DisplayRamPtr,long RowBytes){	DrawAcharUPP	DrawAChProc;				if (DrawAcharRes){ // dispacht si resource pas loader		DrawAChProc = (DrawAcharUPP)*DrawAcharRes;		return CallDrawAchar_Proc(DrawAChProc,Font_Render,TheChar,TheStyle,Face_Color,Border_Color,Shadow_Color,bgd_Color,drapeau,Xpos,Ypos,DisplayRamPtr,RowBytes);	} else {		return C_Draw_A_Char(Font_Render,TheChar,TheStyle,Face_Color,Border_Color,Shadow_Color,bgd_Color,drapeau,Xpos,Ypos,DisplayRamPtr,RowBytes);	}} //PPCDispatch_Call_C_Draw_A_Char//*******************************************// cette fonction est le wrapper pour render_a_font//avec la fonction en resource PPCpascal short C_Render_A_font(FontRenderRecordPtr FontRender,GDHandle  GraphicDeviceH,long RowBytes,Ptr BaseAdresse){	C_Render_A_font_EngUPP 	Proc;				if (RenderAFontRes){ // dispacht si resource pas loader		Proc = (C_Render_A_font_EngUPP)*RenderAFontRes;		return C_Render_A_font_EngProc(Proc,FontRender,GraphicDeviceH,RowBytes,BaseAdresse);	} else {		return C_Render_A_font_Eng(FontRender,GraphicDeviceH,RowBytes,BaseAdresse);	}} //C_Render_A_font//*******************************************// cette fonction est le wrapper pour dessiner un sous-titre//avec la fonction en resource PPCshort PPCDispatch_Call_DrawSousTitreEng(FontRenderRecordPtr FontRender,			SousTitreRecordPtr STPtr,short X,short Y,Ptr ScreenPtr,			long RowBytes,	DrawStParamPtr DP,Rect *rect){	Draw_SousTitreEng_UPP	DrawSTProc;				short a;			GrafPtr	oldPtr;	#ifndef __Debug__		// pour le debug en 68K	if (DrawStAccRes){ // dispacht si resource pas loader		DrawSTProc = (Draw_SousTitreEng_UPP)*DrawStAccRes;		a=CallDrawSTEng_Proc(DrawSTProc,FontRender, STPtr,X,Y,ScreenPtr,RowBytes,DP,rect);		} else {		a=Draw_SousTitreEng(FontRender, STPtr,X,Y,ScreenPtr,RowBytes,DP,rect);		}#else		a=Draw_SousTitreEng(FontRender, STPtr,X,Y,ScreenPtr,RowBytes,DP,rect);	#endif				return a;} //PPCDispatch_Call_DrawSousTitreEng			//**********************************************			// fonctions de chargement et déclaration des fonctions en resource PPC...						