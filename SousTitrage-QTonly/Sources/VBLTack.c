#include "BB.Globals_C.h"#include "E3DEMO.H"#include "appleEventHandlers.h"/* 	 Routine VBL sous intérruption*/asm void VBLMainTask(void){		cmp.w	#$118,G.VE_BoardID		beq		Exit				; vista classic carte pas bonne pour nous		cmp.w	#$346,G.VE_BoardID		beq		CutEffect			; seulement cut pour nuvista+		cmp.w	#$28C,G.VE_BoardID		beq		CutEffect			; seulement cut pour nuvista+   		move.w	G.EffectMode,d0 		cmp.w	#1,d0 		beq		FonduEffect; c'est un cutCutEffect		move.w	G.DrawState,d1		and.w	#$8000,d1		beq 	exit				; si bit 15=0 on ne fait rien		move.w	G.DrawState,d1		tst.b	d1					; que faire ?		beq  	effacecarteCut			; on efface après le fondu			; on affiche la ram				move.l	G.Base_Adresse,d0		beq		Exit		cmp.w	#$346,G.VE_BoardID		;vista+ ?		beq.s	touchapasAmonIcf		cmp.w	#$118,G.VE_BoardID		;vista ?		beq.s	touchapasAmonIcf		cmp.w	#$28C,G.VE_BoardID		;vista+ ?		beq.s	touchapasAmonIcf		and.l	#$ff000000,d0		add.l	#registerSpaceStart,d0		move.l	d0,a0							; base des registres de la Video Explorer		move.w	#$40,VX_ICFScaleFactor(a0)		; on reset le icf de la valeur d'incrémentationtouchapasAmonIcf		bsr		Display_Buffer					; on active l'affichage		bra 	exiteffacecarteCut; on affiche la ram				move.l	G.Base_Adresse,d0		beq		Exit		cmp.w	#$346,G.VE_BoardID		;nuvista+ ?		beq.s	touchapasAmonIcf1		cmp.w	#$118,G.VE_BoardID		;nuvista ?		beq.s	touchapasAmonIcf1		cmp.w	#$28C,G.VE_BoardID		;vista+ ?		beq.s	touchapasAmonIcf1		and.l	#$ff000000,d0		add.l	#registerSpaceStart,d0		move.l	d0,a0							; base des registres de la Video Explorer		move.w	#$40,VX_ICFScaleFactor(a0)		; on reset le icf de la valeur d'incrémentationtouchapasAmonIcf1		bsr		NOt_Display_Buffer		bra 	exit; ------------------------------------------; c'est un fonduFonduEffect				tst.w	G.FadeTime		beq		CutEffect	; si durée=0 c'est un cut		move.w	G.DrawState,d1		and.w	#$4000,d1		bne		PourIncDEc			; faire incrémentation décrémentation icf factor ?;	non pas inc dec car premier appel ou rien à faire				move.w	G.DrawState,d1				and.w	#$8000,d1		bne		PremierPassageDanslaRoutine						bra		exit				; si bit 15=0 on ne fait rien; ---PourIncDEc; on regarde pour faire fondu ; est-ce une vidéo explorer ?		cmp.w	#$346,G.VE_BoardID		; nu vista+ ou vx 		beq 	Exit		cmp.w	#$28C,G.VE_BoardID		;vista+ ?		beq 	Exit; on calcule l'adresse des registres		move.l	G.Base_Adresse,d0	; carte présente ?		beq		Exit		and.l	#$ff000000,d0				add.l	#registerSpaceStart,d0		move.l	d0,a0			; base des registres de la Video Explorer; Inc ou Dec		move.w	G.DrawState,d1		tst.b	d1		beq.s		doDisDown	; decdoDisUp ; inc		move.w	G.FadeFactor,d0		addq.w	#1,d0		cmp.w	G.FadeTime,d0		bls		doDisUp1		move.w	G.FadeTime,d0		move.w	d0,G.FadeFactor		bra 	ExitdoDisUp1		move.w	d0,G.FadeFactor		move.w	G.FadeFactor,d0		mulu	#$40,d0		divu	G.FadeTime,d0		move.w	d0,VX_ICFScaleFactor(a0)		bra 	exitpasFini; --------------doDisDown ; out		move.w	G.FadeFactor,d0		subq.w	#1,d0		cmp.w	#0,d0		bhi		doDisDown1		clr.w	G.FadeFactor		bsr		Not_Display_Buffer		;on désactive l'affichage du buffer		bra 	ExitdoDisDown1		move.w	d0,G.FadeFactor		move.w	G.FadeFactor,d0		mulu	#$40,d0		divu	G.FadeTime,d0		move.w	d0,VX_ICFScaleFactor(a0) 		bra		exitpasFini; ---------------------------PremierPassageDanslaRoutine		; on regarde si nu vista classic ?; si oui on ne fait rien		cmp.w	#$118,G.VE_BoardID		beq		Exit		cmp.w	#$346,G.VE_BoardID		beq		Exit		cmp.w	#$28C,G.VE_BoardID		;vista+ ?		beq 	Exit		move.w	G.DrawState,d1		tst.b	d1					; que faire ?		beq.s	DissolveOut			; on commence par le début		move.l	G.Base_Adresse,d0		beq		Exit		and.l	#$ff000000,d0		add.l	#registerSpaceStart,d0		move.l	d0,a0							; base des registres de la Video Explorer		; on commence par la valeur 1		move.w	#1,G.FadeFactor		move.w	#64,d0		divu	G.FadeTime,d0		move.w	d0,VX_ICFScaleFactor(a0)		bsr		Display_Buffer					; on active l'affichage		bra		exitpasFini						; ; en fait on ne fait rien , mais on place le icf au maximumDissolveOut		move.w	G.FadeTime,d0		move.w	d0,G.FadeFactor		move.l	G.Base_Adresse,d0		beq		Exit		and.l	#$ff000000,d0		add.l	#registerSpaceStart,d0		move.l	d0,a0							; base des registres de la Video Explorer		move.w	#$40,VX_ICFScaleFactor(a0)		; on démarre de pleine ouverture		bra		exitpasFini; ----------------------------------------; on affiche la ram; au prochain appel de la VRAM on incrémente le icf factor; carte présente ?; on calcule l'adresse des registres		move.l	G.Base_Adresse,d0		beq		Exit		and.l	#$ff000000,d0		add.l	#registerSpaceStart,d0		move.l	d0,a0						; base des registres de la Video Explorer		clr.w	VX_ICFScaleFactor(a0)		; on démarre de zéro		bsr		Display_Buffer		bra.s	exitpasFini; ---------------------------------------Exit; on à fini le travail; on sort de la routine, on raz le bit 15			move.w	G.DrawState,d0		and.w	#$0f,d0		move.w	d0,G.DrawState; on reset le vblCount				lea		G.VBL_Structure,a0		move.w	#1,VblCount(a0)		movem.l	(sp)+,a5		; on rend le registres		rts; on dit que l'on doit faire le fonduexitpasFini		move.w	G.DrawState,d1		or.w	#$C000,d1		move.w	d1,G.DrawState; on reset le vblCount				lea		G.VBL_Structure,a0		move.w	#1,VblCount(a0)		movem.l	(sp)+,a5		; on rend le registres		rts}	