#include "BB.Globals_C.h"// les globalsextern AppGlobals G;extern MyQDGlobals QD;pascal void Not_Display_Buffer(void);pascal void Display_Buffer(void);pascal void The_VBLTask (void);// def pour la carte VideoExplorer#define VX_ICFScaleFactor	0x0340#define VXRegBase			0xF00000void SetICFFactor(short icf);// la routine synchrone en VBL taskpascal void The_VBLTask (void){long		a;	if (G.VE_BoardID==0x118) return ; // carte Nu vista classic		if (	G.VE_BoardID==0x346 ||		G.VE_BoardID==0x28c ) { //  nu-vista + ?			if (!(G.DrawState&0x8000)) return ; // on ne fait rien					if (G.DrawState&0x0f){				 Display_Buffer();				 G.DrawState=1;				} else {				 Not_Display_Buffer();				 G.DrawState=0;			}	} // gestion nu-vista +// ----------------------------------------------		if( G.VE_BoardID==0x2a2){ // video explorer ?		if (G.EffectMode){ // effet de fondu				//gestion du fondu		// on utilise 3variables		//G.DrawState&0x4000 pour indiquer que nous sommes en train de faire un fondu		//G.DrawState&1 pour indiquer si c'est un fondu entrant ou sortant		//fadefactor=ou on en est dans le fondu		//fade time = le temps de fondu 		if (!(G.DrawState&0x8000)) return ; //rien à faire ....							if (G.DrawState&0x0f) { //entrée en fondu				if (!(G.DrawState&0x4000)){ 			// c'est le début du fondu					G.FadeFactor=0;				//on prépare le fondu					G.DrawState|=0x4000;					SetICFFactor(0);	// démarrage du fondu					Display_Buffer();	//ouverture du canal de key				}					G.FadeFactor++;					if (G.FadeFactor>=(G.FadeTime+1)) {	// fin du fondu						G.DrawState=1;						SetICFFactor(64); // valeur nominale					} else {							a=(64*G.FadeFactor)/(G.FadeTime+1);							SetICFFactor(a);						}											// fin de l'entrée en fondu				} else {//sortie en fondu								if (!(G.DrawState&0x4000)){ 			// c'est le début du fondu					G.FadeFactor=G.FadeTime+1;		//on prépare le fondu					G.DrawState|=0x4000;					} 					G.FadeFactor--;					if (G.FadeFactor<=0) {	// fin du fondu						Not_Display_Buffer();						G.DrawState=0;						} else {							a=(64*G.FadeFactor)/(G.FadeTime+1);							SetICFFactor(a);						}				}			} else {	// effet de cut			if (!(G.DrawState&0x8000)) return ; // on ne fait rien			if (G.DrawState&0x0f) {				Display_Buffer();				G.DrawState=1;				} else {				Not_Display_Buffer();				G.DrawState=0;			}	 	}			} // Vx// ----------------------------------------------}// Cette routine permet de commander le facteur de mélange de la VXvoid SetICFFactor(short icf){long		LL;short*	sp;	LL=(long)G.Base_Adresse;	LL=LL&0xff000000;	LL+=VX_ICFScaleFactor;	LL+=VXRegBase;	*((short*)LL)=icf;}